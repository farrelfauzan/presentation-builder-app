name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'docker-compose.prod.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          source: "."
          target: "~/presentation-builder-app"
          overwrite: true

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 30m
          script: |
            cd ~/presentation-builder-app
            export TERM=xterm-256color

            # Stop containers (keep volumes to preserve DB data)
            docker compose -f docker-compose.prod.yml down

            # Rebuild and start everything (uses layer cache for speed)
            docker compose -f docker-compose.prod.yml up -d --build

            # Clean up dangling images only (not all cache)
            docker image prune -f

            # Wait for postgres to be healthy
            echo "Waiting for postgres to be ready..."
            for i in $(seq 1 30); do
              if docker exec presentation-db pg_isready -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} > /dev/null 2>&1; then
                echo "Postgres is ready!"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done

            # Run database migrations
            docker exec -i presentation-db psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} <<'EOF'
            CREATE TYPE "MediaType" AS ENUM ('image', 'video');

            CREATE TABLE IF NOT EXISTS "global_settings" (
                "id" TEXT NOT NULL,
                "company_name" TEXT,
                "logo_url" TEXT,
                "address" TEXT,
                "email" TEXT,
                "website" TEXT,
                "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
                "updated_at" TIMESTAMPTZ NOT NULL,
                "deleted_at" TIMESTAMPTZ,
                CONSTRAINT "global_settings_pkey" PRIMARY KEY ("id")
            );

            CREATE TABLE IF NOT EXISTS "projects" (
                "id" TEXT NOT NULL,
                "title" TEXT NOT NULL,
                "description" TEXT,
                "version" TEXT,
                "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
                "updated_at" TIMESTAMPTZ NOT NULL,
                "deleted_at" TIMESTAMPTZ,
                CONSTRAINT "projects_pkey" PRIMARY KEY ("id")
            );

            CREATE TABLE IF NOT EXISTS "slides" (
                "id" TEXT NOT NULL,
                "project_id" TEXT NOT NULL,
                "order" INTEGER NOT NULL,
                "text_content" TEXT,
                "media_url" TEXT,
                "media_type" "MediaType",
                "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
                "updated_at" TIMESTAMPTZ NOT NULL,
                "deleted_at" TIMESTAMPTZ,
                CONSTRAINT "slides_pkey" PRIMARY KEY ("id")
            );

            CREATE INDEX IF NOT EXISTS "slides_project_id_order_idx" ON "slides"("project_id", "order");

            ALTER TABLE "slides" ADD CONSTRAINT "slides_project_id_fkey" FOREIGN KEY ("project_id") REFERENCES "projects"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
            EOF

            # Verify all containers are running
            docker ps

            echo "Backend deployed successfully!"
